# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

Puzzle 3 of the "Mission: Hollywood" escape room. A virtual assistant (AI video) presents 3 situations. For each, players identify the correct spy gadget from a physical display and type its 4-digit code on a USB numpad. Correct codes light physical LEDs. All 3 lit = puzzle solved.

## Commands

```bash
npm run dev     # Start in mock mode (no GPIO, auto-activates) — for development
npm start       # Start in production mode (GPIO LEDs) — for Raspberry Pi
```

Dev mode serves at http://localhost:3001. Type digits 0-9 + Enter to submit codes.

### Dev Controls (mock mode only)

- Digits 0-9 + Enter: input codes
- Backspace: delete last digit
- Escape: clear code
- A: activate puzzle
- R: reset puzzle
- F: force solve

## Architecture

```
server/index.js        → Entry point: HTTP/WebSocket server, routes messages, auto-activate in mock mode
server/puzzleLogic.js  → State machine: INACTIVE → INTRO → SITUATION 1/2/3 → SOLVED
server/leds.js         → GPIO LED control via onoff, mock fallback logs to console
config.js              → Situations (video + code), video filenames, LED pins, port
public/index.html      → Fullscreen video player with HUD overlay (situation dots, code dots, scanlines)
public/app.js          → WebSocket client, video playback, keyboard input, HUD updates
public/videos/         → Video clips (placeholder .mp4 files for dev, replace with AI-generated later)
generate-placeholders.js → Utility: generates simple placeholder video clips via ffmpeg
```

## Data Flow

```
Numpad keypress (browser keydown)
      │
      ▼
  WebSocket → server/puzzleLogic.js checks code
      │
      ├─ correct → GPIO LED on, play correct.mp4, then next situation
      └─ wrong → play wrong.mp4, return to idle
      │
      ▼
  WebSocket → browser plays video clip
```

## State Machine

INACTIVE → (activate) → INTRO → (intro ends) → SITUATION 1 → (correct) → SITUATION 2 → (correct) → SITUATION 3 → (correct) → SOLVED

Wrong codes play a rejection clip and return to the current situation.

## Key Design Decisions

- **Video-first UI**: the browser is essentially a fullscreen video player with a minimal HUD overlay.
- **Idle loop**: between clips, `idle.mp4` loops seamlessly to keep the screen alive.
- **Input via browser keyboard events**: USB numpad appears as a keyboard, browser captures keydown events and sends digits to server via WebSocket. Server validates.
- **Mock mode** (`--mock`): auto-activates puzzle on first client connection for easy testing.
- **Situation clips vs feedback clips**: situation clips trigger `situationClipEnded` (distinct from `clipEnded` for correct/wrong/solved/intro) so the state machine knows when to transition to input-waiting state.

## GPIO Pin Mapping (Raspberry Pi)

Defined in `config.js`:
- LED 1 (Situation 1): GPIO 24
- LED 2 (Situation 2): GPIO 25
- LED 3 (Situation 3): GPIO 12

## Placeholder Videos

Generated by `node generate-placeholders.js` (requires ffmpeg). Simple colored backgrounds with white text. Replace with AI-generated assistant clips for production.

## Not Yet Implemented

- Room Controller WebSocket integration
- Kiosk boot setup script
- Production AI-generated video clips
